name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # ============================================
  # Stage 1: Set Go Version
  # ============================================
  env:
    runs-on: ubuntu-latest
    outputs:
      go_version: ${{ steps.env.outputs.go_version }}
    steps:
      - name: Set go version
        id: env
        run: echo "go_version=1.24" >> $GITHUB_OUTPUT
  # ============================================
  # Stage 2: Build
  # ============================================
  build:
    name: Build
    needs: env
    uses: ./.github/workflows/build.yml
    with:
      go_version: ${{ needs.env.outputs.go_version }}
    secrets: inherit

  # ============================================
  # Stage 3: Test & Lint
  # ============================================
  test:
    name: Test
    needs: [build, env]
    uses: ./.github/workflows/test.yml
    with:
      go_version: ${{ needs.env.outputs.go_version }}
    secrets: inherit
  
  lint:
    name: Lint
    needs: [build, env]
    uses: ./.github/workflows/lint.yml
    with:
      go_version: ${{ needs.env.outputs.go_version }}
    secrets: inherit

  # ============================================
  # Stage 4: Publish
  # ============================================
  publish:
    name: Publish
    needs: [build, test, lint, env]
    uses: ./.github/workflows/publish.yml
    with:
      go_version: ${{ needs.env.outputs.go_version }}
    secrets: inherit

  # ============================================
  # Stage 5: Update Homebrew
  # ============================================
  release-brew:
    name: Update Homebrew
    needs: publish
    uses: ./.github/workflows/release-brew.yml
    with:
      tag_name: ${{ github.ref_name }}
    secrets: inherit

